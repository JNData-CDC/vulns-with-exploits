from typing import Set

import json

from os import path
from datetime import datetime

from config import NVD_DIR
from config import EDB_DIR, EDB_MAPPING_FILE_NAME

from NVDHelper import get_nvd_years, nvd_file_basename, nvd_file_name, nvd_file_path

class VulnsWithExploits:
    def __init__(self):
        self.nvd_dir: str = NVD_DIR
        self.mapping_file: str = path.join(EDB_DIR, EDB_MAPPING_FILE_NAME)
    
    def get_vulns_from_json(self, filepath: str, start_date, end_date) -> Set[str]:
        """Gets all the vulns from a single NVD json file with 'publishedDate' parameter within the specified dates

        Args:
            filepath (str): Path of a NVD json file

        Returns:
            set: A set containing IDs (CVE numbers) of all the vulns found in a single NVD json file within the date range
        """
        vulns = set()
        with open(filepath, mode="r", encoding="utf-8") as j:
            content = json.load(j)
        # ID: content["CVE_Items"][num]["cve"]["CVE_data_meta"]["ID"]
        # date: content["CVE_Items"][num]["publishedDate"]
        for item in content["CVE_Items"]:
            # get date, if within range, add to set
            publishedDate = datetime.strptime(item["publishedDate"], "%Y-%m-%dT%H:%MZ").date()
            if (start_date <= publishedDate <= end_date):
                vulns.add(item["cve"]["CVE_data_meta"]["ID"])
        return vulns

    def get_vuln_ids(self, start_date, end_date) -> Set[str]:
        """Gets all the vulns registered in NVD within the specified dates (based on 'publishDate' parameter from NVD)

        Args:
            start_date (datetime.date): start of the date range
            end_date (datetime.date): end of the date range

        Returns:
            set: A set containing IDs (CVE numbers) of all the vulns registered in NVD within the time range
        """

        vulns_total = set()
        for year in get_nvd_years(start_date, end_date):
            base_f = nvd_file_basename(year)
            json_f = nvd_file_name(base_f,"json")
            json_path = nvd_file_path(path.join(NVD_DIR, json_f))
            # add vulns to total
            vulns_total.update(self.get_vulns_from_json(json_path, start_date, end_date))
        print(f"DEBUG: total number of CVEs within the timerange: {len(vulns_total)}")
        return vulns_total

    def get_vulns_with_exploits(self, start_date, end_date) -> Set[str]:
        # get all the CVEs for a given time range
        vulns = self.get_vuln_ids(start_date, end_date)

        # open the mapping file
        with open(self.mapping_file, mode="r", encoding="utf-8") as j:
            mapping = json.load(j)["mapping"]
        
        vulns_with_exploits: Set[str] = {x for x in vulns if x in mapping}
        print(f"DEBUG: total number of CVEs mapped to exploits in ExploitDB : {len(mapping)}")
        print(f"DEBUG: number of CVEs within the timerange with exploits available: {len(vulns_with_exploits)}")
        return vulns_with_exploits
